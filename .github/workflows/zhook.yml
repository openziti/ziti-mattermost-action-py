name: mattermost-ziti-webhook
on:
  issues:
  issue_comment:
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
  pull_request:
    types: [opened, reopened]
  push:
  fork:
  release:
    types: [released]
  workflow_dispatch:
  watch:
    types: [started]

jobs:
  mattermost-ziti-webhook:
    runs-on: ubuntu-24.04
    name: POST Webhook
    steps:
      - name: Debug
        uses: hmarr/debug-action@v3

      - name: Install Valgrind
        shell: bash
        run: sudo apt-get install --yes valgrind gdb

      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Python Script Directly
        if: |
          github.repository_owner == 'openziti'
          && ((github.event_name != 'pull_request_review')
          || (github.event_name == 'pull_request_review' && github.event.review.state == 'approved'))
        env:
          INPUT_ZITIID: ${{ secrets.ZITI_MATTERMOST_IDENTITY }}
          INPUT_WEBHOOKURL: ${{ secrets.ZHOOK_URL_DEV_NOTIFICATIONS }}
          INPUT_EVENTJSON: ${{ toJson(github.event) }}
          INPUT_SENDERUSERNAME: GitHubZ
          INPUT_SENDERICONURL: https://github.com/fluidicon.png
          ZITI_LOG: 6
          TLSUV_DEBUG: 6
        shell: bash
        run: |
          set -o pipefail
          set -o xtrace
          pip install --user --upgrade --requirement ./requirements.txt
          sudo sysctl -w kernel.core_pattern='/tmp/core.%e.%p.%t'
          ulimit -c unlimited
          valgrind --verbose --log-file=/tmp/zook.py-valgrind-%p-%n.log --leak-check=full python ./zhook.py

      - uses: ./
        name: Run as a GH Action from the Local Checkout
        if: |
          github.repository_owner == 'openziti'
          && ((github.event_name != 'pull_request_review')
          || (github.event_name == 'pull_request_review' && github.event.review.state == 'approved'))
        with:
          zitiId: ${{ secrets.ZITI_MATTERMOST_IDENTITY }}
          webhookUrl: ${{ secrets.ZHOOK_URL_DEV_NOTIFICATIONS }}
          eventJson: ${{ toJson(github.event) }}
          senderUsername: GitHubZ

      - name: Print Debug Info
        if: always()
        shell: bash
        run: |
          set -o pipefail
          set -o xtrace
          echo "DEBUG: PYTHONPATH=${PYTHONPATH:-}"
          echo "DEBUG: PATH=${PATH:-}"
          echo "DEBUG: LD_LIBRARY_PATH=${LD_LIBRARY_PATH:-}"
          find $(python -c "import site; print(site.USER_SITE)") -path "*/openziti*" -name "*.so*" -type f -print0 | xargs -0r ldd
          cat /tmp/zook.py-valgrind-*.log
          if [ -s /tmp/core.python.* ]; then
            echo "DEBUG: Core dump found"
            gdb -q $(realpath $(which python)) -c /tmp/core.python.* --ex bt --ex exit
          fi